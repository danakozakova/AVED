---
title: "Cvičení 9: ggplot2 - Vizualizace dat"
subtitle: "MPE_AVED - Analýza a vizualizace ekonomických dat"
author: "Vaše meno"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: false
    theme: cosmo
    highlight: tango
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  comment = "#>",
  fig.width = 8,
  fig.height = 4
)
```

# Načítání balíků

```{r packages}
library(tidyverse)
library(tibble)
```

---

# Cvičení na rozehřátí: Úmrtí řidičů v UK a nošení pásů

Analyzujte data o úmrtích řidičů ve Velké Británii v souvislosti se zavedením povinného používání bezpečnostních pásů.

## Načtení a prozkoumání dat

```{r rozehnuti_data}
# Načtěte data
seatbelts <- datasets::Seatbelts %>% 
  as.matrix()

seatbelts %>% 
  glimpse()

seatbelts %>% data.frame(
  as.matrix(.),
  year = time(.),
  month = cycle(.)
) %>% 
  select(year, month, everything()) %>% 
  as_tibble() %>%
  print(n = 5)

seatbelts %>% data.frame(
  as.matrix(.),
  year = time(.),
  month = cycle(.)
) %>% 
  as_tibble() %>%
  mutate(
    year = as.character(trunc(year)), 
    # alebo: year = as.character(year) %>% str_extract("^\\d{4}"),
    month = ifelse(month < 10, str_c('0', month), as.character(month))
  ) %>% 
  select(year, month, everything()) %>% 
  print(n = 5)

seatbelts <- seatbelts %>% data.frame(
  as.matrix(.),
  year = time(.),
  month = cycle(.)
) %>% 
  as_tibble() %>%
  mutate(
    year = as.character(trunc(year)), 
    # alebo: year = as.character(year) %>% str_extract("^\\d{4}"),
    month = ifelse(month < 10, str_c('0', month), as.character(month)),
    date = str_c(year, "-", month, '-01') %>% as.Date()
  ) 

seatbelts %>% 
  select(year, month, date, everything()) %>% 
  print(n = 5)
```

## Základní vizualizace
Časová řada

```{r rozehnuti_vizualizace}
seatbelts %>%
  ggplot(
    aes(x = date, y = drivers)
  ) +
  geom_line()
```

2. Barevně odlište období před/po uvedení zákona v platnost (proměnná `law`)
```{r rozehnuti_male_rozsireni}
seatbelts$law %>% unique()

seatbelts %>%
  ggplot(
    aes(x = date, y = drivers, color = as.character(law) )
  ) +
  geom_line()

```
Upravte jméno proměnné a hodnoty v legendě

- 'scale_color_discrete()' slouží k úpravě legendy a barev pro diskrétní (kategorickou) proměnnou, která je namapována na `color`.
```{r}
Sys.setlocale("LC_ALL", "Czech")
seatbelts %>%
  ggplot(
    aes(x = date, y = drivers, color = as.character(law) )
  ) +
  geom_line() +
  scale_color_discrete(
    name = 'Zákon o pásech', # nadpis legendy
    breaks = c(0, 1), # hodnoty na zobrazenie
  )
```
- 'scale_color_brewer()'  používá předdefinované barevné palety od ColorBrewer.
```{r}
seatbelts |>
   mutate(
     law = law > 0 # transformace na logicku
   ) |> 
   ggplot(
     aes(x = date, y = drivers, color = law)
     ) +
   geom_line() +
   scale_color_brewer(
     "Plati zakon o povinnem \nnoseni pasu?",
     palette = "Dark2",
     labels = c("TRUE" = "Ano", "FALSE" = "Ne")
   )

 seatbelts |>
   mutate(
     law = law > 0
   ) |> 
   ggplot(
     aes(x = date, y = drivers, color = law)
     ) +
   geom_line() +
   geom_point() +
   scale_color_brewer(
     "Plati zakon o povinnem \nnoseni pasu?",
     palette = "Dark2",
     labels = c("TRUE" = "Ano", "FALSE" = "Ne")
   )

```
## Malé rozšírenie
```{r}
  seatbelts |>
   mutate(
     law = law > 0
   ) |> 
   ggplot(
     aes(x = date, y = drivers, color = law)
     ) +
   geom_line() +
   geom_point() +
   annotate( # vykreslenie hranic je podla dat, nie podla annotate
     "rect",
     ymin = -Inf,
     ymax = Inf,
     xmax = Inf,
     xmin = as.Date("1983-01-31")
   ) +
   scale_color_brewer(
     "Plati zakon o povinnem \nnoseni pasu?",
     palette = "Dark2",
     labels = c("TRUE" = "Ano", "FALSE" = "Ne")
   )
```

```{r}
# zmena poradia prvkov a ciastocna priehladnost
seatbelts |>
  mutate(
    law = law > 0
  ) |>
  ggplot(
    aes(x = date, y = drivers, color = law)
    ) +
  annotate(
    "rect",
    ymin = -Inf,
    ymax = Inf,
    xmax = Inf,
    xmin = as.Date("1983-01-31"),
    alpha = 0.3
  ) +
  geom_line() +
  geom_point() +
  scale_color_brewer(
    "Plati zakon o povinnem \nnoseni pasu?",
    palette = "Dark2",
    labels = c("TRUE" = "Ano", "FALSE" = "Ne")
  )
```

## Zajímavější rozšíření...
Oblíbenou identifikační strategií je tzv. regression discontinuity design (RDD), který používá skokovou změnu v momentu (místě,…) intervence pro identifikaci jejího kauzálního efektu. Zkuste nakreslit obrázek, který tuto změnu ukáže:

```{r}
# Přidejte trendy, popisky, vylepšete vzhled
# skalovanie hodnoty do farieb - colorbrewer2.org
# smooth
seatbelts |>
  mutate(
    law = law > 0
  ) |>
  ggplot(
    aes(x = date, y = drivers, color = law)
    ) +
  annotate(
    "rect",
    ymin = -Inf,
    ymax = Inf,
    xmax = Inf,
    xmin = as.Date("1983-01-31"),
    alpha = 0.3
  ) +
  geom_line() +
  geom_point() +
  geom_smooth() +
  scale_color_brewer(
    "Plati zakon o povinnem \nnoseni pasu?",
    palette = "Dark2",
    labels = c("TRUE" = "Ano", "FALSE" = "Ne")
  )
 
# odstranenie farby, ale namiesto toho group
seatbelts |>
  mutate(
    law = law > 0
  ) |>
  ggplot(
    aes(x = date, y = drivers, group = law)
    ) +
  annotate(
    "rect",
    ymin = -Inf,
    ymax = Inf,
    xmax = Inf,
    xmin = as.Date("1983-01-31"),
    alpha = 0.3
  ) +
  geom_line() +
  geom_point() +
  geom_smooth()
  
```

---

# Cvičení A: Ve zdravém těle...

Vizualizace dat o zdraví a fyzické kondici.

## Načtení dat

```{r ukol_a_nacteni}
oly12 <- VGAMdata::oly12 %>%
  as_tibble()

print(oly12)
```
Z tabulky oly12 vytvoříme tabulku s průměrnou váhou a výškou pro skupiny vymezené sportem a pohlavím:

```{r}
oly12_stats <- oly12 %>% 
    mutate(
        Sport = str_extract(Sport, "[:alnum:]*")
    ) %>% 
    group_by(Sex,Sport) %>% 
    summarise(
        Height = mean(Height, na.rm = TRUE),
        Weight = mean(Weight, na.rm = TRUE)
    ) %>% 
    ungroup() %>% 
    drop_na() 
```

## Úkol A.1: Explorativní vizualizace
```{r}
oly12 |> 
  ggplot(
    aes(x = Height, y = Weight)
  ) + 
  geom_point()
# prilis vela bodov, vola sa to overplotting
```

```{r}
# pohlavie
# priehladnost bodov
oly12 |> 
  arrange(Sex) |> 
  ggplot(
    aes(x = Height, y = Weight, color = Sex)
  ) + 
  geom_point(
    alpha = 0.1
  )

```

```{r}
# pridam geom_smooth
oly12 |> 
  arrange(Sex) |> 
  ggplot(
    aes(x = Height, y = Weight, color = Sex)
  ) + 
  geom_point(
    size = 0.1,
    alpha = 0.1
  ) +
  geom_smooth()

```
Tato vizualizace naznačuje, že v datech jsou dvě vzájemně posunutá mračna – ženy a muži. Úplně jasno o vztahu ale nemáme, kvůli obrovskému overplottingu.

V tomto případě může pomoci něco jako vícerozměrný histogram – např. `geom_hex()`:
```{r}
# namiesto stvorcov sestuholniky
oly12 |> 
  arrange(Sex) |> 
  ggplot(
    aes(x = Height, y = Weight)
  ) + 
  geom_hex()
```
```{r}
# vlastnosti
oly12 |> 
  arrange(Sex) |> 
  ggplot(
    aes(x = Height, y = Weight)
  ) + 
  geom_hex() +
  scale_fill_distiller(
    palette = "Green",
    direction = -1
  )

```

## Facetování
Pro pohled na muže a ženy zvlášť je potom možné a užitečné použít facetování:
```{r}
oly12 %>% 
    ggplot(
        aes(x = Height, y = Weight)
    ) +
    geom_hex() +
    facet_wrap("Sex", scales = "free")
```

Můžeme rozšířit obrázek o dodatečnou datovou vrstvu – pozici průměrů pro jednotlivé sporty
```{r}
oly12 %>% 
    ggplot(
        aes(x = Height, y = Weight)
    ) +
    geom_hex() +
    geom_point(
        data = oly12_stats,
        aes(shape = Sport),
        size = 3,
        color = "red"
    ) +
    scale_shape_manual(values = c(65:90)) +
    facet_wrap("Sex", scales = "free")
```

```{r}
# rozdel na facety
oly12 |> 
  arrange(Sex) |> 
  ggplot(
    aes(x = Height, y = Weight)
  ) + 
  geom_hex() +
  scale_fill_distiller(
    palette = "Green",
    direction = -1
  ) +
  facet_wrap(~Sex) # rovnake hranice
```
```{r}
oly12 |> 
  arrange(Sex) |> 
  ggplot(
    aes(x = Height, y = Weight, color = Sex)
  ) + 
  geom_density_2d()
```

Kernel density
```{r}
# iny pristup: vybrat nahodny set


oly12_sample <- oly12 |> 
  group_by(Sex) |>
  slice_sample(n = 1000) |> 
  ungroup()

set.seed(42)
oly12_sample |> 
  arrange(Sex) |> 
  ggplot(
    aes(x = Height, y = Weight, color = Sex)
  ) + 
  geom_density_2d()

```
---

# Cvičení B: Rozdělení spojité proměnné

Práce s histogramy, hustotními grafy a dalšími vizualizacemi distribucí.

## Vytvoření dat

```{r ukol_b_nacteni}
datax <- data_frame(
  x = rnorm(1000)
)

```

## Úkol B.1: Histogram

```{r ukol_b_1}
datax %>%
  ggplot(
    aes(x = x)
  ) +
  geom_histogram(aes(y = ..density..), bins = 50) 

datax %>%
  ggplot(
    aes(x = x)
  ) +
  geom_histogram(aes(y = ..density..), bins = 50) +
  geom_density()
```
Občas bývá užitečné okometricky zkontrolovat, zda data pocházejí z nějakého rozdělení – v tomto případě normálního. Zkuste do obrázku přidat hustotu normálního rozdělení.
Hint: 'stat_function()'
```{r ukol_b_2}

datax %>%
  ggplot(
    aes(x = x)
  ) +
  geom_histogram(aes(y = ..density..), bins = 50) +
  geom_density() +
  stat_function(
    fun = dnorm,
    color = "red"
  )
```
---

# Cvičení C: Komplexní vizualizace

Vytvoření profesionální vizualizace s použitím všech naučených technik.

## Načtení dat

```{r ukol_c_nacteni}
library(readxl)
library(countrycode)

cpi <- read_excel('gapminder_cpi.xlsx') 
cpi

cpi <- cpi %>% 
  rename(country = 1) %>% 
  pivot_longer(cols = -country,
               names_to = 'year',
               values_to = 'cpi',
               names_transform = list(year = as.numeric)
               )

cpi

hdi <- read_excel('gapminder_hdi.xlsx') %>% 
  rename(country = HDI) %>%
  pivot_longer(
    cols = -country,
    names_to = 'year',
    values_to = 'hdi',
    names_transform = list(year = as.numeric) 
  )
hdi
```

## Úprava dat

```{r ukol_c_krok1}
plot_data <- left_join(cpi, hdi, by = c('country', 'year')) %>% 
              # Spojí CPI a HDI podle země a roku
  pivot_longer(
    cols = -c(country, year),
    names_to = 'variable',
    values_to = 'value'
  ) %>%
    #Vyber nejnovější data pre kazdu krajinu a HDI/CPI
  arrange(-year) %>%
  group_by(country, variable) %>%
  slice(1L)


plot_data <- left_join(cpi, hdi, by = c('country', 'year')) %>% 
              # Spojí CPI a HDI podle země a roku
  pivot_longer(
    cols = -c(country, year),
    names_to = 'variable',
    values_to = 'value'
  ) %>%
    #Vyber nejnovější data pre kazdu krajinu a HDI/CPI
  arrange(-year) %>%
  group_by(country, variable) %>%
  slice(1L) %>%
    # naspat na siroky format
  select(-year) %>%
  pivot_wider(
    names_from = variable,
    values_from = value
  ) %>% 
  ungroup() %>%
  drop_na()
plot_data

```
Pripojenie labelov
```{r}
plot_data <- read_tsv("country_labels.tsv", col_types = "cc") %>%
  left_join(plot_data,., by="country")
plot_data
```
```{r}
plot_data$continent <- plot_data$country %>% 
    countrycode("country.name","continent")
plot_data
```
## Krok 1: Vizualizace dat
Vzorový obrázek obsahuje tři vizualizace dat:

- Body reprezentující pozorované hodnoty
- Křivku vyhlazující pozorované hodnoty
- Popisky vybraných pozorování

Pro vizualizaci dat tedy budeme muset vytvořit pomocí funkcí `geom_*()` celkem tři vrstvy. Do obrázku je musíme zanést v takovém pořadí, aby výsledek odpovídal výslednému obrázku.

**Hint:**

- Body na vzorovém obrázku mají barevný okraj a bílý střed. Pozorování tedy musí být vizualizováno pomocí geometrického tvaru, který umožňujenastavit zvlášť vlastnosti (barvu) středu a okraje. To umožňuje například body tvaru číslo 21.
- Pro zobrazení popisků existuje v **ggplot2** `geom_text()` a `geom_label()`. Tyto funkce však neumí "inteligentní" pozicování popisků tak, aby nedocházelo k překryvům. Zkuste použít `ggrepel::geom_text_repel()`.
```{r}
library(ggrepel)
p <- plot_data %>%
  ggplot(
    aes(x = cpi, y = hdi)
  ) +
  geom_smooth(
    se = FALSE,
    color = 'red',
    formula = y ~ log(x),
    method = 'lm'
  ) +
  geom_point(
    aes(color = continent),
    shape = 21,
    size = 4,
    fill = 'white',
    stroke = 1.2
  ) +
  geom_text_repel(
    aes(label = country_label)
  )
p
```
## Krok 2: Nastavení mapování

Nastavte estetické mapování pro lepší interpretaci dat.

```{r ukol_c_krok2}
# Upravte mapování v aes()
# - barva podle kategorie
# - velikost podle hodnoty
# - průhlednost
p <- p +
    scale_y_continuous(
        name = "Human development index, 2011 (1=best)",
        breaks = seq(from = 0.1, to = 1.1, by = 0.1)
        ) +
    scale_x_continuous(
        name = "Corruption Perception Index, 2011 (10=least corrupt)",
        breaks = 0:11
        ) +
    coord_cartesian(xlim = c(0.99,10.01), ylim = c(0.2,1)) +
    labs(
       title = "Corruption and human development",
       caption = "Source: Gapminder"
    )

p

```

## Krok 3: Nastavení vzhledu

Vylepšete vzhled grafu pomocí témat, škál a popisků.

```{r ukol_c_krok3}
# Použijte theme_*()
# Upravte popisky pomocí labs()
# Nastavte škály (scale_*())

p + theme_classic() +
    theme(
        # Přidáme linky na pozadí
        panel.grid.major.y = element_line(size = 0.1),
        # Nastavíme podobu os
        axis.ticks.y = element_blank(),
        axis.line.y = element_blank(),
        axis.line.x = element_line(lineend = "square"),
        # Nastavíme pozici a podobu legendy
        legend.position = "top",
        legend.direction = "horizontal",
        legend.title = element_blank(),
        # nastavíme podobu popisků
        plot.caption = element_text(hjust = 0),
        plot.title = element_text(face = "bold"),
        axis.title = element_text(face = "italic")
    )
```

---

# Typy grafů v ggplot2

## Spojité proměnné

```r
# Bodový graf
ggplot(data, aes(x = var1, y = var2)) +
  geom_point()

# Čárový graf
ggplot(data, aes(x = time, y = value)) +
  geom_line()

# Plošný graf
ggplot(data, aes(x = time, y = value)) +
  geom_area()

# Vyhlazená křivka
ggplot(data, aes(x = var1, y = var2)) +
  geom_smooth()
```

## Rozdělení dat

```r
# Histogram
ggplot(data, aes(x = variable)) +
  geom_histogram(bins = 30)

# Hustotní graf
ggplot(data, aes(x = variable)) +
  geom_density()

# Krabicový graf
ggplot(data, aes(x = category, y = value)) +
  geom_boxplot()

# Houslový graf
ggplot(data, aes(x = category, y = value)) +
  geom_violin()
```

## Kategorické proměnné

```r
# Sloupcový graf
ggplot(data, aes(x = category)) +
  geom_bar()

# Sloupcový graf s hodnotami
ggplot(data, aes(x = category, y = value)) +
  geom_col()

# Seskupený sloupcový graf
ggplot(data, aes(x = category, y = value, fill = group)) +
  geom_col(position = "dodge")
```

---

# Estetické mapování (aes)

Estetické vlastnosti můžeme mapovat na proměnné:

```r
ggplot(data, aes(x = var1, 
                 y = var2,
                 color = category,    # barva podle kategorie
                 size = value,        # velikost podle hodnoty
                 shape = type,        # tvar podle typu
                 alpha = weight,      # průhlednost podle váhy
                 linetype = group))   # typ čáry podle skupiny
```

**Důležité:**
- Mapování uvnitř `aes()` → proměnná
- Pevné hodnoty mimo `aes()` → konstanta

```r
# ✅ Správně - mapování na proměnnou
geom_point(aes(color = category))

# ✅ Správně - pevná hodnota
geom_point(color = "blue")

# ❌ Chyba - pevná hodnota v aes()
geom_point(aes(color = "blue"))
```

---

# Facetování

## facet_wrap()

Pro rozdělení podle jedné proměnné:

```r
ggplot(data, aes(x = var1, y = var2)) +
  geom_point() +
  facet_wrap(~ category, ncol = 2)
```

## facet_grid()

Pro rozdělení podle dvou proměnných:

```r
# Řádky ~ Sloupce
ggplot(data, aes(x = var1, y = var2)) +
  geom_point() +
  facet_grid(rows_var ~ cols_var)

# Pouze řádky
facet_grid(rows_var ~ .)

# Pouze sloupce
facet_grid(. ~ cols_var)
```

---

# Témata a vzhled

## Vestavěná témata

```r
theme_gray()      # výchozí
theme_bw()        # černobílé
theme_minimal()   # minimalistické
theme_classic()   # klasické
theme_light()     # světlé
theme_dark()      # tmavé
```

## Vlastní úpravy

```r
ggplot(data, aes(x = var1, y = var2)) +
  geom_point() +
  labs(
    title = "Hlavní nadpis",
    subtitle = "Podnadpis",
    x = "Popis osy X",
    y = "Popis osy Y",
    caption = "Zdroj dat"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    axis.text = element_text(size = 12),
    legend.position = "bottom"
  )
```

---

# Škály a barvy

## Spojité škály

```r
# Úprava osy X
scale_x_continuous(limits = c(0, 100), breaks = seq(0, 100, 20))

# Logaritmická škála
scale_y_log10()

# Barevná škála pro spojité hodnoty
scale_color_gradient(low = "blue", high = "red")
scale_color_viridis_c()  # viridis paleta
```

## Diskrétní škály

```r
# Manuální barvy
scale_color_manual(values = c("red", "blue", "green"))

# Vestavěné palety
scale_color_brewer(palette = "Set1")
scale_color_viridis_d()  # viridis paleta (diskrétní)
```

---

# Důležité poznámky

## Anatomie ggplot grafu

```r
ggplot(data = <DATA>) +                    # 1. Data
  <GEOM_FUNCTION>(                         # 2. Geom
    mapping = aes(<MAPPINGS>),             # 3. Mapování
    stat = <STAT>,                         # 4. Statistická transformace
    position = <POSITION>                  # 5. Pozice
  ) +
  <COORDINATE_FUNCTION> +                  # 6. Souřadnicový systém
  <FACET_FUNCTION> +                       # 7. Facety
  <SCALE_FUNCTION> +                       # 8. Škály
  <THEME_FUNCTION>                         # 9. Téma
```

## Časté problémy a řešení

### Problém 1: Překrývající se body

```r
# ❌ Body se překrývají
geom_point()

# ✅ Přidání průhlednosti
geom_point(alpha = 0.5)

# ✅ Použití jitter
geom_jitter(width = 0.2, height = 0.2)
```

### Problém 2: Přeplněné popisky

```r
# ❌ Nečitelné popisky na ose X
ggplot(data, aes(x = category, y = value)) +
  geom_col()

# ✅ Otočení popisků
ggplot(data, aes(x = category, y = value)) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# ✅ Nebo otočení souřadnic
ggplot(data, aes(x = category, y = value)) +
  geom_col() +
  coord_flip()
```

### Problém 3: Automatické bins v histogramu

```r
# ⚠️ Varování o automatickém počtu binů
ggplot(data, aes(x = variable)) +
  geom_histogram()

# ✅ Explicitní nastavení
ggplot(data, aes(x = variable)) +
  geom_histogram(bins = 30)
# nebo
ggplot(data, aes(x = variable)) +
  geom_histogram(binwidth = 5)
```

---

# Kombinování geomů

Můžete kombinovat více geomů v jednom grafu:

```r
ggplot(data, aes(x = var1, y = var2)) +
  geom_point(alpha = 0.5) +              # Body
  geom_smooth(method = "lm", se = TRUE) + # Trendová čára
  geom_hline(yintercept = 0, linetype = "dashed") # Horizontální čára
```

---

# Ukládání grafů

```r
# Vytvoření grafu
p <- ggplot(data, aes(x = var1, y = var2)) +
  geom_point()

# Uložení
ggsave("muj_graf.png", plot = p, width = 8, height = 6, dpi = 300)

# Různé formáty
ggsave("muj_graf.pdf", plot = p)
ggsave("muj_graf.svg", plot = p)
```
