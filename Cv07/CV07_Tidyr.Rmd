---
title: "CviÄenÃ­ 7: tidyr - Transformace dat"
subtitle: "MPE_AVED - AnalÃ½za a vizualizace ekonomickÃ½ch dat"
author: "VaÅ¡e meno"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
    theme: cosmo
    highlight: tango
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  comment = "#>"
)
```

# ğŸ“š Ãšvod

V tomto cviÄenÃ­ si procviÄÃ­te pouÅ¾Ã­vÃ¡nÃ­ zÃ¡kladnÃ­ch nÃ¡strojÅ¯ z balÃ­ku **tidyr**, kterÃ© znÃ¡te z pÅ™ednÃ¡Å¡ky:

- **`pivot_longer()`** - transformace Å¡irokÃ© tabulky na dlouhou (wide â†’ long)
- **`pivot_wider()`** - transformace dlouhÃ© tabulky na Å¡irokou (long â†’ wide)
- **`separate()`** / **`separate_wider_delim()`** - rozdÄ›lenÃ­ sloupcÅ¯
- **`complete()`** - doplnÄ›nÃ­ chybÄ›jÃ­cÃ­ch kombinacÃ­
- **`fill()`** - vyplnÄ›nÃ­ chybÄ›jÃ­cÃ­ch hodnot
- **`separate_rows()`** - rozdÄ›lenÃ­ bunÄ›k na vÃ­ce Å™Ã¡dkÅ¯

# ğŸ“¦ NaÄÃ­tÃ¡nÃ­ balÃ­kÅ¯

```{r packages}
# NaÄtÄ›te potÅ™ebnÃ© balÃ­ky


```

---

# ğŸ”¥ CviÄenÃ­ na rozehÅ™Ã¡tÃ­

## Transpozice tabulky

**ZadÃ¡nÃ­:** NapiÅ¡te kÃ³d, kterÃ½ transponuje `tidyr::table4a`:

```{r ukol_rozehnrti_data}
# ZobrazenÃ­ pÅ¯vodnÃ­ tabulky
table4a
```

**CÃ­l:** Vyprodukovat tabulku, kde roky budou jako sloupce a zemÄ› jako Å™Ã¡dky:

```
# A tibble: 3 Ã— 4
  year  Afghanistan Brazil       China
  <chr>       <dbl>  <dbl>       <dbl>
1 1999          745  37737      212258
2 2000         2666  80488      213766
```

**Zkuste problÃ©m vyÅ™eÅ¡it pomocÃ­ funkcÃ­ `pivot_longer()` a `pivot_wider()`.**

```{r ukol_rozehnrti}
# 1. PouÅ¾ijte pivot_longer() na transformaci do dlouhÃ©ho formÃ¡tu


# 2. PouÅ¾ijte pivot_wider() na transpozici


```

**NÃ¡povÄ›da:**

- PrvnÃ­ krok: `pivot_longer(-country, names_to = "year")`
- DruhÃ½ krok: `pivot_wider(names_from = country)`

---

# ğŸ¥• CviÄenÃ­ A: Psychologie zeleniny

PÅ™Ã­klad nÃ¡s zavede do perspektivnÃ­ho pole **psychologie zeleniny**. Data z Guilford et al. (1954) obsahujÃ­ data o preferencÃ­ch nad pÃ¡ry zelenin. ÄŒÃ­sla jsou podÃ­l voleb zeleniny ve sloupci pÅ™ed zeleninou v Å™Ã¡dku.

Tabulku `veg` najdete v balÃ­ku `psychTools`.

## NaÄtenÃ­ dat

```{r ukol_a_nacteni}
# NaÄtÄ›te data


# ZobrazenÃ­ dat


```

## PÅ™emÄ›na do tidy formÃ¡tu

**ZadÃ¡nÃ­:** PÅ™eveÄte tabulku do tidy formÃ¡tu. VÃ½sledek by mÄ›l vypadat takto:

```
# A tibble: 144 Ã— 3
   Veg_B    Veg_A     value
   <chr>    <chr>     <dbl>
 1 asparagus asparagus  0.5 
 2 asparagus beans      0.53
 3 asparagus broccoli   0.58
   ...
```

Sloupec `value` obsahuje podÃ­l preferencÃ­ Veg_A pÅ™ed Veg_B.

```{r ukol_a_tidy}
# KROK 1: VloÅ¾enÃ­ jmen Å™Ã¡dkÅ¯ do sloupce
# S pomocÃ­ balÃ­ku tibble:


# Nebo s pomocÃ­ base R:


# KROK 2: Transformace do tidy formÃ¡tu pomocÃ­ pivot_longer()


# KROK 3 (volitelnÃ©): SeÅ™azenÃ­ podle hodnoty


```

**PoznÃ¡mky:**

- PÅ¯vodnÃ­ tabulka je `data.frame` s nÃ¡zvy Å™Ã¡dkÅ¯
- MusÃ­me jmÃ©na Å™Ã¡dkÅ¯ vloÅ¾it do "normÃ¡lnÃ­ho" sloupce
- V ukÃ¡zkovÃ©m Å™eÅ¡enÃ­ je pouÅ¾it "negativnÃ­ vÃ½Äet" sloupcÅ¯: `-Veg_B`

---

# ğŸŒ CviÄenÃ­ B: Data z databÃ¡ze World Bank

JednÃ­m z nejfrekventovanÄ›jÅ¡Ã­ch zdrojÅ¯ makro dat je bezpochyby databÃ¡ze WDI, kterou provozuje World Bank.

## NaÄtenÃ­ dat

**StÃ¡hnÄ›te** si tabulku, kterÃ¡ bude obsahovat data:

- **MÃ­ra porodnosti** (`SP.DYN.CBRT.IN`)
- **Ãšmrtnosti** (`SP.DYN.CDRT.IN`)
- **ÄŒistÃ© migrace** (`SM.POP.NETM`)

```{r ukol_b_nacteni, eval=FALSE}
# StaÅ¾enÃ­ dat z World Bank API
library(wbstats)



# Pokud API nefunguje, naÄtÄ›te ze souboru:
# load("exdata07/tidyr_wbdata.RData")
```

```{r ukol_b_nacteni_backup, echo=FALSE}
# Pro knit dokumentu - naÄtenÃ­ ze souboru
# load("exdata07/tidyr_wbdata.RData")
```

## ProhlÃ©dnutÃ­ struktury

```{r ukol_b_struktura}
# VypiÅ¡te prvnÃ­ch 5 Å™Ã¡dkÅ¯


```

**Struktura tabulky:**

- `country` a `iso2c` = duplicitnÃ­ ID pro zemi
- `date` = rok pozorovÃ¡nÃ­ (jako character!)
- `indicatorID` a `indicator` = duplicitnÃ­ ID promÄ›nnÃ©
- `value` = pozorovanÃ¡ hodnota

## Transformace do tidy formÃ¡tu

**ZadÃ¡nÃ­:** Transformujte tabulku tak, aby jeden Å™Ã¡dek obsahoval hodnoty vÅ¡ech promÄ›nnÃ½ch pro unikÃ¡tnÃ­ kombinaci mÃ­sta a Äasu.

**CÃ­lovÃ½ vÃ½sledek:**

```
# A tibble: ... Ã— 6
  country     iso2c date  SM.POP.NETM SP.DYN.CBRT.IN SP.DYN.CDRT.IN
  <chr>       <chr> <chr>       <dbl>          <dbl>          <dbl>
1 Afghanistan AF    1960           NA           52.3           29.4
2 Afghanistan AF    1961           NA           52.3           29.3
  ...
```

```{r ukol_b_transformace}
# Transformace pomocÃ­ pivot_wider()
# POZOR: MusÃ­te vyÅ™eÅ¡it problÃ©m s duplicitnÃ­mi ID!


```

**OtÃ¡zka k pÅ™emÃ½Å¡lenÃ­:**

Zkuste spustit nÃ¡sledujÃ­cÃ­ kÃ³d. ProbÄ›hne bez varovÃ¡nÃ­, ale vÃ½sledek nebude sprÃ¡vnÃ½. ProÄ?

```{r ukol_b_chyba, eval=FALSE}
wbdata %>% 
  pivot_wider(names_from = indicatorID)
```

**NÃ¡povÄ›da:**

- ProblÃ©m: duplicitnÃ­ sloupce `indicatorID` a `indicator`
- Å˜eÅ¡enÃ­ 1: VylouÄit sloupec `indicator` pÅ™ed transformacÃ­
- Å˜eÅ¡enÃ­ 2: PouÅ¾Ã­t parametr `id_cols = c(country, iso2c, date)`

---

# ğŸ“ˆ PÅ™Ã­klad C: FinanÄnÃ­ data z Yahoo Finance

ZpracovÃ¡nÃ­ finanÄnÃ­ch dat - cen akciÃ­ Alphabet Inc. (GOOG) z Yahoo Finance.

## NaÄtenÃ­ dat

```{r ukol_c_nacteni}
# NaÄtÄ›te CSV soubor


# ZobrazenÃ­ dat


```

## RozdÄ›lenÃ­ sloupce Date

**ZadÃ¡nÃ­:** V prvnÃ­m sloupci najdete datum jako character ve formÃ¡tu `"YYYY-MM-DD"`. RozloÅ¾te sloupec `Date` do numerickÃ½ch sloupcÅ¯ `year`, `month` a `day`.

```{r ukol_c_separate}
# PouÅ¾ijte funkci separate()


```

**Parametry:**

- `sep = "-"` - oddÄ›lovaÄ
- `convert = TRUE` - automatickÃ¡ konverze na sprÃ¡vnÃ½ typ

**PoznÃ¡mka:** V praxi je lepÅ¡Ã­:

1. NaÄÃ­st datum jako typ `Date` (parametr funkce `read_csv`)
2. Nebo konvertovat: `as.Date()` nebo s pomocÃ­ `lubridate`
3. Exportovat sloupce pomocÃ­ `strftime()` nebo funkcÃ­ z `lubridate`

---

# ğŸŒ CviÄenÃ­ D: World Population Prospects (2017)

OSN publikuje ve World Population Prospects demografickÃ¡ data pro vÅ¡echny stÃ¡ty svÄ›ta a obdobÃ­ 1950-2015. Data jsou pro roky dÄ›litelnÃ© pÄ›ti.

## NaÄtenÃ­ dat

```{r ukol_d_nacteni}
# NaÄtÄ›te data


# ZobrazenÃ­ prvnÃ­ch 5 Å™Ã¡dkÅ¯


```

## Ãškol

ProveÄte nÃ¡sledujÃ­cÃ­ transformace:

1. **PÅ™esklÃ¡dat data** do tidy formÃ¡tu
2. **PÅ™emÄ›nit implicitnÃ­ chybÄ›jÃ­cÃ­ hodnoty** na explicitnÃ­
3. **Doplnit chybÄ›jÃ­cÃ­ hodnoty** poslednÃ­ pozorovanou hodnotou

**CÃ­lovÃ½ vÃ½sledek:**

```
# A tibble: 15,906 Ã— 4
   country_code name        year population
          <dbl> <chr>      <int>      <dbl>
 1            4 Afghanistan 1950       8150
 2            4 Afghanistan 1951       8150
 3            4 Afghanistan 1952       8150
   ...
```

### Krok 1: Konverze do tidy formÃ¡tu

```{r ukol_d_krok1}
# Transformace pomocÃ­ pivot_longer()
# - VÃ½Äet sloupcÅ¯: NEGATIVNÃ (-c(country_code, name))
# - Konverze roku na integer: names_transform = list(year = as.integer)


```

**PoznÃ¡mky:**

- NegativnÃ­ vÃ½Äet je univerzÃ¡lnÄ›jÅ¡Ã­ (pÅ™ipraven na updaty)
- Konvertujte rok na `integer` pro snadnÄ›jÅ¡Ã­ prÃ¡ci s daty

### Krok 2: Konverze implicitnÃ­ch NA na explicitnÃ­

**ProblÃ©m:** Data obsahujÃ­ pouze roky dÄ›litelnÃ© pÄ›ti. OstatnÃ­ roky jsou **implicitnÄ›** chybÄ›jÃ­cÃ­.

```{r ukol_d_krok2}
# PouÅ¾ijte funkci complete()
# complete(country_code, name, year = 1950:2015)

# LEPÅ Ã: PouÅ¾ijte placeholder pro univerzÃ¡lnÄ›jÅ¡Ã­ Å™eÅ¡enÃ­


```

**POZOR: ProblÃ©m s duplicitnÃ­m ID!**

ZemÄ› je identifikovÃ¡na jak `name`, tak `country_code`. MusÃ­me pouÅ¾Ã­t `nesting()`:

```{r ukol_d_krok2_fix}
# SprÃ¡vnÃ© Å™eÅ¡enÃ­ s nesting()


```

**VysvÄ›tlenÃ­:**

- Bez `nesting()`: $N \times N \times T = 3{,}833{,}346$ Å™Ã¡dkÅ¯ âŒ
- S `nesting()`: $N \times T = 15{,}906$ Å™Ã¡dkÅ¯ âœ…

### Krok 3: DoplnÄ›nÃ­ chybÄ›jÃ­cÃ­ch hodnot

**ZadÃ¡nÃ­:** DoplÅˆte chybÄ›jÃ­cÃ­ hodnoty populace poslednÃ­ pozorovanou hodnotou (forward fill).

```{r ukol_d_krok3}
# PouÅ¾ijte funkci fill()
# .direction = "down" - doplnÄ›nÃ­ z pÅ™edchozÃ­ch Å™Ã¡dkÅ¯


```

**POZOR: fill() doplnÃ­ hodnoty "dolÅ¯"**

MusÃ­me zajistit:

1. SprÃ¡vnÃ© poÅ™adÃ­ Å™Ã¡dkÅ¯ (seÅ™azenÃ­ podle roku)
2. SkupinovÃ¡nÃ­ podle zemÄ› (aby se nedoplÅˆovaly hodnoty mezi zemÄ›mi)

**SprÃ¡vnÃ©, protektovanÃ© Å™eÅ¡enÃ­:**

```{r ukol_d_krok3_fix}
# KompletnÃ­ Å™eÅ¡enÃ­ s group_by() a arrange()


```

**VysvÄ›tlenÃ­ pouÅ¾itÃ½ch funkcÃ­ (z dplyr):**

- `group_by(country_code)` - seskupenÃ­ podle zemÄ›
- `arrange(year, .by_group = TRUE)` - seÅ™azenÃ­ v rÃ¡mci skupin
- `fill(population, .direction = "down")` - doplnÄ›nÃ­ hodnot
- `ungroup()` - zruÅ¡enÃ­ seskupenÃ­

---

# ğŸ“ CviÄenÃ­ E: Data z Google Forms

Google Forms je platforma pro tvorbu jednoduchÃ½ch dotaznÃ­kÅ¯. OdpovÄ›di jsou uklÃ¡dÃ¡ny do tabulek ve formÃ¡tu CSV.

## Struktura dotaznÃ­ku

DotaznÃ­k obsahuje tÅ™i typy otÃ¡zek:

1. **Radiobutton** - lze zvolit pouze jednu odpovÄ›Ä
2. **Checkbox** - respondent mÅ¯Å¾e zvolit vÃ­ce odpovÄ›dÃ­
3. **Radiobutton grid** - v kaÅ¾dÃ©m Å™Ã¡dku lze zvolit prÃ¡vÄ› jednu odpovÄ›Ä

## NaÄtenÃ­ dat

```{r ukol_e_nacteni}
# NaÄtÄ›te CSV soubor


# ZobrazenÃ­ dat


```

**ProblÃ©m:** VÃ­ce hodnot oddÄ›lenÃ½ch ";" je namaÄkÃ¡no v jednÃ© buÅˆce u otÃ¡zky checkbox. Data nejsou tidy!

## Ãškol 1: PÅ™ejmenovÃ¡nÃ­ sloupcÅ¯

**ZadÃ¡nÃ­:** PÅ™ejmenujte sloupce tak, aby novÃ¡ jmÃ©na odpovÃ­dala kÃ³dÅ¯m otÃ¡zek: `q1`, `q2`, `q3a`, `q3b` a `q3c`.

```{r ukol_e_rename}
# SpÃ´sob 1: PomocÃ­ names()


# SpÃ´sob 2: PomocÃ­ rename() z dplyr


```

## Ãškol 2: Transformace sloupce q2

**ZadÃ¡nÃ­:** Transformujte sloupec `q2` tak, Å¾e ho rozdÄ›lÃ­te na 4 sloupce (`q2_1`, `q2_2`, `q2_3` a `q2_4`), odpovÃ­dajÃ­cÃ­ jednotlivÃ½m moÅ¾nostem. V kaÅ¾dÃ©m novÄ› vytvoÅ™enÃ©m sloupci bude logickÃ¡ promÄ›nnÃ¡ `TRUE`/`FALSE`.

**POZOR:** Variantu 4 si nezvolil nikdo, ale pÅ™esto mÃ¡ mÃ­t svÅ¯j sloupec!

**NÃ¡povÄ›da:** `separate_rows()`

### PomocnÃ½ krok: PÅ™idÃ¡nÃ­ ID

```{r ukol_e_id}
# PÅ™idejte sloupec ID pro identifikaci respondenta


```

### Å˜eÅ¡enÃ­ 1: JednoduÅ¡Å¡Ã­ (ale ne ÃºplnÃ©)

```{r ukol_e_reseni1}
# 1. RozdÄ›lenÃ­ bunÄ›k pomocÃ­ separate_rows()


# 2. PÅ™idÃ¡nÃ­ pomocnÃ©ho sloupce s TRUE


# 3. PouÅ¾itÃ­ pivot_wider()


```

**ProblÃ©m:** StÃ¡le by bylo nutnÃ©:

- PÅ™ejmenovat sloupce `Option 1`, `Option 2`, `Option 3`
- ManuÃ¡lnÄ› doplnit sloupec pro `Option 4`

### Å˜eÅ¡enÃ­ 2: KompletnÃ­ (s faktorem)

```{r ukol_e_reseni2}
# KlÃ­ÄovÃ¡ zmÄ›na: konverze q2 na faktor s definovanÃ½mi ÃºrovnÄ›mi


# separate_rows()


# PomocnÃ½ sloupec


# pivot_wider() s names_expand = TRUE


```

**Parametry pivot_wider():**

- `names_expand = TRUE` - vytvoÅ™Ã­ sloupec i pro nepozorovanÃ½ level
- `values_fill = FALSE` - doplnÃ­ FALSE mÃ­sto NA

**POZNÃMKA:** Toto Å™eÅ¡enÃ­ vyÅ¾aduje novÄ›jÅ¡Ã­ verzi tidyr (â‰¥ 1.2.0)!

---

# ğŸ“Š PÅ™ehled funkcÃ­ tidyr

## Wide â†” Long transformace

```r
# Wide â†’ Long (smrÅ¡tÄ›nÃ­ sloupcÅ¯)
pivot_longer(data, cols, names_to, values_to)

# Long â†’ Wide (rozÅ¡Ã­Å™enÃ­ na sloupce)
pivot_wider(data, names_from, values_from)
```

## RozdÄ›lenÃ­ a spojenÃ­

```r
# RozdÄ›lenÃ­ sloupce na vÃ­ce sloupcÅ¯
separate(data, col, into, sep, convert = FALSE)
separate_wider_delim(data, cols, delim, names)

# RozdÄ›lenÃ­ buÅˆky na vÃ­ce Å™Ã¡dkÅ¯
separate_rows(data, col, sep)

# SpojenÃ­ sloupcÅ¯
unite(data, col, ..., sep = "_")
```

## ChybÄ›jÃ­cÃ­ hodnoty

```r
# DoplnÄ›nÃ­ vÅ¡ech kombinacÃ­
complete(data, ...)
complete(data, nesting(...), ...)  # Pro duplicitnÃ­ ID

# VyplnÄ›nÃ­ chybÄ›jÃ­cÃ­ch hodnot
fill(data, col, .direction = c("down", "up", "downup", "updown"))

# OdstrÃ¡nenie Å™Ã¡dkÅ¯ s NA
drop_na(data, ...)
```

## VnoÅ™enÃ© struktury

```r
# VytvoÅ™enÃ­ vnoÅ™enÃ© struktury
nest(data, ...)

# RozbalenÃ­ vnoÅ™enÃ© struktury
unnest(data, cols)
```

---

# ğŸ’¡ DÅ¯leÅ¾itÃ© poznÃ¡mky

## Tidy data pravidla

1. **KaÅ¾dÃ¡ promÄ›nnÃ¡ mÃ¡ vlastnÃ­ sloupec**
2. **KaÅ¾dÃ© pozorovÃ¡nÃ­ mÃ¡ vlastnÃ­ Å™Ã¡dek**
3. **KaÅ¾dÃ¡ hodnota mÃ¡ vlastnÃ­ buÅˆku**

## ÄŒastÃ© problÃ©my a Å™eÅ¡enÃ­

### ProblÃ©m 1: DuplicitnÃ­ ID

```r
# âŒ CHYBA
complete(country_code, name, year)  # VytvoÅ™Ã­ NÃ—NÃ—T kombinacÃ­

# âœ… Å˜EÅ ENÃ
complete(nesting(country_code, name), year)  # VytvoÅ™Ã­ NÃ—T kombinacÃ­
```

### ProblÃ©m 2: ImplicitnÃ­ vs. explicitnÃ­ NA

```r
# ImplicitnÃ­ NA - chybÃ­ Å™Ã¡dek
# ExplicitnÃ­ NA - Å™Ã¡dek existuje, hodnota je NA

# Konverze implicitnÃ­ch â†’ explicitnÃ­
complete(data, col1, col2)
```

### ProblÃ©m 3: fill() vyÅ¾aduje sprÃ¡vnÃ© poÅ™adÃ­

```r
# âŒ NebezpeÄnÃ©
data %>% fill(value)

# âœ… BezpeÄnÃ©
data %>%
  group_by(id) %>%
  arrange(time, .by_group = TRUE) %>%
  fill(value) %>%
  ungroup()
```

---

# ğŸ¯ Checklist

- [ ] RozumÃ­m rozdÃ­lu mezi wide a long formÃ¡tem?
- [ ] VÃ­m, kdy pouÅ¾Ã­t `pivot_longer()` a `pivot_wider()`?
- [ ] DokÃ¡Å¾u pracovat s `complete()` a `nesting()`?
- [ ] ChÃ¡pu rizika pouÅ¾itÃ­ `fill()` bez sprÃ¡vnÃ©ho seskupenÃ­?
- [ ] VÃ­m, jak pracovat s duplicitnÃ­mi ID sloupci?
- [ ] UmÃ­m pouÅ¾Ã­t `separate_rows()` pro rozdÄ›lenÃ­ bunÄ›k?

---

# ğŸ”— UÅ¾iteÄnÃ© odkazy

- [tidyr cheatsheet](https://github.com/rstudio/cheatsheets/blob/main/tidyr.pdf)
- [R for Data Science - Tidy data](https://r4ds.had.co.nz/tidy-data.html)
- [tidyr documentation](https://tidyr.tidyverse.org/)

---

<div style="text-align: center; margin-top: 50px; padding: 20px; background-color: #f0f0f0; border-radius: 10px;">
**VytvorenÃ© pre:** MPE_AVED, TÃ½Å¾deÅˆ 7, ECON MUNI  
**DÃ¡tum:** `r Sys.Date()`
</div>
