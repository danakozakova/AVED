---
title: "CviÄenÃ­ 12: Ekonometrie v R"
subtitle: "MPE_AVED - AnalÃ½za a vizualizace ekonomickÃ½ch dat"
author: "Dana KozÃ¡kovÃ¡"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
    theme: cosmo
    highlight: tango
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  comment = "#>",
  fig.width = 8,
  fig.height = 6
)
```

# Ãšvod

V tomto cviÄenÃ­ si procviÄÃ­te zÃ¡kladnÃ­ ekonometrickÃ© metody v R:

- **OLS regrese** - metoda nejmenÅ¡Ã­ch ÄtvercÅ¯
- **Diagnostika modelÅ¯** - testy, residuÃ¡ly, multikolinearita
- **RobustnÃ­ standardnÃ­ chyby** - prÃ¡ce s heteroskedasticitou
- **PanelovÃ¡ data** - fixed effects, random effects
- **Vizualizace odhadÅ¯** - grafy koeficientÅ¯ a predikce

# NaÄÃ­tÃ¡nÃ­ balÃ­kÅ¯

```{r packages}
library(tidyverse)
library(broom) # vezme objekt a vyklopi ho do tibble
# library(gt)
# library(lmtest)
# library(sandwich)
# library(plm)
# library(stargazer)
# library(modelsummary) # na zobrazenie jednoduchych vystupov z modelov

```

---

# CviÄenÃ­ na rozehÅ™Ã¡tÃ­: DlouhÃ½ a Å¡irokÃ½

Ãšvod do prÃ¡ce s ekonometrickÃ½mi daty a jejich transformace.
V tomto cviÄenÃ­ se podÃ­vÃ¡me na to, jak se dÄ›lÃ¡ test shody stÅ™ednÃ­ch hodnot â€“ t-test. PodÃ­vÃ¡me se na data z tabulky `VGAMdata::ugss`:

## NaÄtenÃ­ dat

```{r rozehnuti_data}
# NaÄtÄ›te data
ugss <- VGAMdata::ugss %>% as_tibble()
ugss |> head()
```

**Pohled na data**
Bude nÃ¡s zajÃ­mat, zda Å¾eny a muÅ¾i (sex) platÃ­ stejnÄ› za holiÄe (hair).
Nejprve si to mÅ¯Å¾eme nakreslit:

```{r}
ugss %>% 
  ggplot(aes(x = hair, fill = sex)) +
  geom_density(alpha = 0.4, bw = 10) + 
  theme_classic()
```

1. Co na to Å™Ã­kÃ¡ **t-test**? Hint: pÅ™eÄtÄ›te si nÃ¡povÄ›du k funkci `t.test()` a zkuste pouÅ¾Ã­t metodu pro tÅ™Ã­du `formula`.
```{r}
ugss %>% t.test(hair ~ sex, data = .)
```

2. S normalitou vÃ½dajÅ¯ na kadeÅ™nÃ­ka to bude asi problematickÃ©. Zkuste pouÅ¾Ã­t Mann-Whitney U-test (`wilcox.test()`)
```{r}
ugss %>% wilcox.test(hair ~ sex, data = .)
```
Funkce vracejÃ­ objekty rÅ¯znÃ½ch tÅ™Ã­d (napÅ™. `htest`). ObÄas se hodÃ­ vytvoÅ™it si z tÄ›chto objektÅ¯ tabulku s pÅ™ehledem vÃ½sledkÅ¯. K tomu se dÃ¡ napÅ™Ã­klad pouÅ¾Ã­t funkce `broom::glance()`.
Ta ze vstupnÃ­ho objektu vytvoÅ™Ã­ sumarizaÄnÃ­ tabulku o jednom Å™Ã¡dku. Funkce funguje pouze pro objekty, pro kterÃ© v balÃ­ku broom existuje metoda.
```{r}
ugss %>% wilcox.test(hair ~ sex, data = .) %>% glance()
ugss %>% t.test(hair ~ sex, data = .) %>% glance()

```

**HrÃ¡tky s `lm()`**
```{r}
r <- ugss %>% lm(sleep ~ sex, data = .)
r
```
ReferenÄnÃ­ hodnota je female. Chceme zmÄ›nit na "male". 
```{r}
ugss |> mutate(sex = sex |> relevel(ref = "male")) %>%
  lm(sleep ~ sex, data = .)
```
EÅ¡te aj vÃ½znamnost:
```{r}
ugss |> mutate(sex = sex |> relevel(ref = "male")) %>%
  lm(sleep ~ sex, data = .) |> summary()
```
Namiesto lm z kniÅ¾nice `tidyverse` pouÅ¾ijeme `feols()` z kniznice `fixest`
```{r}
library(fixest)
ugss |> mutate(sex = sex |> relevel(ref = "male")) %>%
  feols(sleep ~ sex, data = .)
```

Aj definovat ako poÄÃ­taÅ¥ strednÃº chybu:
```{r}
library(fixest)
ugss |> mutate(sex = sex |> relevel(ref = "male")) %>%
  feols(sleep ~ sex, data = ., vcov = "HC1")
```

PouÅ¾itie parametra `split`:
```{r}

```

## Zmena referencnej hodnoty v regresii

```{r rozehnuti_transformace}
# Transformujte data mezi dlouhÃ½m a Å¡irokÃ½m formÃ¡tem
ugss |> mutate(sex = sex |> relevel(ref = "male")) %>%
  feols(
    sleep ~ age, 
    data = ., 
    vcov = "HC1",
    fsplit = ~ sex)

```
## Budovanie regresnÃ©ho modelu
Postupne budujeme regresnÃ½ model

- najprv zoznam
```{r}
list(
  sleep ~ age,
  sleep ~ age + pierced, 
  sleep ~ age + pierced + eyes | tattoeed
)
```

```{r}
list(
  sleep ~ age,
  sleep ~ age + pierced, 
  sleep ~ age + pierced + eyes | tattooed
) |> 
  map(\(x){feols(x, data = ugss)})
```


```{r}
library(Formula)
# prÃ­klad 
s <- a ~ b
update(s, .~.|g)
# musim sklopit do triedy Formula, aby fungovalo viacprvkove
update(as.Formula(s), .~.|g)

```

```{r}
list(
  sleep ~ age,
  sleep ~ age + pierced, 
  sleep ~ age + pierced + eyes | tattooed
) |> 
  map(\(x){feols(x, data = ugss)}) |>
  map(broom::tidy)
```


```{r}
library(modelsummary)
list(
  sleep ~ age,
  sleep ~ age + pierced, 
  sleep ~ age + pierced + eyes | tattooed
) |> 
  map(\(x){feols(x, data = ugss)}) |>
  modelsummary()
```


---

# ğŸ“ CviÄenÃ­ A: HurÃ¡ do Å¡koly (hrajeme si s OLS)

ZÃ¡kladnÃ­ aplikace lineÃ¡rnÃ­ regrese metodou nejmenÅ¡Ã­ch ÄtvercÅ¯ (OLS).

## NaÄtenÃ­ dat

```{r ukol_a_data}
# NaÄtÄ›te Å¡kolnÃ­ data


# ExplorativnÃ­ analÃ½za


```

## Ãškol A.1: JednoduchÃ¡ lineÃ¡rnÃ­ regrese

```{r ukol_a_1}
# OdhadnÄ›te jednoduchÃ½ lineÃ¡rnÃ­ model
# y ~ x


```

**Interpretace:**
- JakÃ½ je sklon regresnÃ­ pÅ™Ã­mky?
- Je koeficient statisticky vÃ½znamnÃ½?
- JakÃ¡ je hodnota RÂ²?

## Ãškol A.2: VÃ­cenÃ¡sobnÃ¡ regrese

```{r ukol_a_2}
# OdhadnÄ›te model s vÃ­ce vysvÄ›tlujÃ­cÃ­mi promÄ›nnÃ½mi


```

**AnalÃ½za:**
- KterÃ© promÄ›nnÃ© jsou vÃ½znamnÃ©?
- Jak se zmÄ›nilo RÂ²?

## Ãškol A.3: Diagnostika modelu

```{r ukol_a_3}
# DiagnostickÃ© testy
# - Normalita reziduÃ­
# - Heteroskedasticita
# - Autokorelace


```

## Ãškol A.4: Vizualizace reziduÃ­

```{r ukol_a_4}
# Grafy reziduÃ­
# - Residual vs Fitted
# - Q-Q plot
# - Scale-Location
# - Residuals vs Leverage


```

---

# ğŸ›¡ï¸ KlastrovanÃ© standardnÃ­ chyby

PrÃ¡ce s robustnÃ­mi standardnÃ­mi chybami pÅ™i poruÅ¡enÃ­ pÅ™edpokladÅ¯ OLS.

## Heteroskedasticita

```{r klastrove_se_1}
# Test heteroskedasticity (Breusch-Pagan test)


```

## RobustnÃ­ standardnÃ­ chyby

```{r klastrove_se_2}
# VÃ½poÄet robustnÃ­ch SE pomocÃ­ sandwich balÃ­ku


```

## KlastrovanÃ© standardnÃ­ chyby

```{r klastrove_se_3}
# KlastrovanÃ© SE podle skupin


```

**PoznÃ¡mka:** RobustnÃ­ a klastrovanÃ© SE jsou dÅ¯leÅ¾itÃ© pro korektnÃ­ inferenci.

---

# ğŸ“ NenÃ­ formula jako Formula

RÅ¯znÃ© zpÅ¯soby specifikace regresnÃ­ch modelÅ¯ v R.

## ZÃ¡kladnÃ­ formule

```{r formula_1}
# ZÃ¡kladnÃ­ specifikace
# y ~ x1 + x2 + x3


```

## Interakce

```{r formula_2}
# InterakÄnÃ­ efekty
# y ~ x1 * x2  (zahrnuje x1 + x2 + x1:x2)
# y ~ x1:x2    (pouze interakce)


```

## Transformace promÄ›nnÃ½ch

```{r formula_3}
# Logaritmy a polynomy
# log(y) ~ log(x1) + I(x2^2)


```

## VÅ¡echny promÄ›nnÃ©

```{r formula_4}
# PouÅ¾itÃ­ vÅ¡ech promÄ›nnÃ½ch kromÄ› y
# y ~ .


```

---

# ğŸ­ CviÄenÃ­ AÃ¡Ã¡Ã¡Ã¡: Simulanti | HranÃ­ si s vÃ½stupnÃ­m objektem

Simulace dat a prÃ¡ce s objekty regresnÃ­ch modelÅ¯.

## Simulace dat

```{r ukol_aaaa_simulace}
# Simulujte data pro regresnÃ­ analÃ½zu
# y = beta0 + beta1*x + epsilon


```

## Odhad modelu

```{r ukol_aaaa_odhad}
# OdhadnÄ›te model na simulovanÃ½ch datech


```

## PrÃ¡ce s vÃ½stupnÃ­m objektem

```{r ukol_aaaa_objekt}
# Extrakce informacÃ­ z lm objektu
# - Koeficienty
# - ResiduÃ¡ly
# - Fitted values
# - RÂ²
# - F-statistika


```

## Funkce broom

```{r ukol_aaaa_broom}
# PouÅ¾itÃ­ broom balÃ­ku
# tidy() - tabulka koeficientÅ¯
# glance() - model statistics
# augment() - data + predictions + residuals


```

---

# ğŸ’¼ CviÄenÃ­ B: Trh prÃ¡ce

Aplikace regresnÃ­ analÃ½zy na data o trhu prÃ¡ce.

## NaÄtenÃ­ dat

```{r ukol_b_data}
# NaÄtÄ›te data o trhu prÃ¡ce


# PopisnÃ© statistiky


```

## Ãškol B.1: MzdovÃ¡ rovnice

```{r ukol_b_1}
# OdhadnÄ›te Mincerovu mzdovou rovnici
# log(wage) ~ education + experience + experience^2


```

**Interpretace:**
- JakÃ½ je nÃ¡vratnost vzdÄ›lÃ¡nÃ­?
- Je zkuÅ¡enost vÃ½znamnÃ¡?
- MÃ¡ zkuÅ¡enost nelineÃ¡rnÃ­ efekt?

## Ãškol B.2: GenderovÃ© rozdÃ­ly

```{r ukol_b_2}
# PÅ™idejte gender do modelu
# Testujte genderovÃ© rozdÃ­ly


```

## Ãškol B.3: Interakce

```{r ukol_b_3}
# Interakce mezi vzdÄ›lÃ¡nÃ­m a genderem


```

**OtÃ¡zka:** LiÅ¡Ã­ se nÃ¡vratnost vzdÄ›lÃ¡nÃ­ mezi muÅ¾i a Å¾enami?

## Ãškol B.4: Predikce

```{r ukol_b_4}
# VytvoÅ™te predikce pro novÃ¡ pozorovÃ¡nÃ­


```

---

# ğŸ“Š CviÄenÃ­ C: PanelovÃ¡ data

PrÃ¡ce s panelovÃ½mi (longitudinÃ¡lnÃ­mi) daty.

## NaÄtenÃ­ panelovÃ½ch dat

```{r ukol_c_data}
# NaÄtÄ›te panelovÃ¡ data


# NastavenÃ­ panelovÃ© struktury


```

## Ãškol C.1: Pooled OLS

```{r ukol_c_1}
# Pooled OLS model (ignoruje panelovou strukturu)


```

## Ãškol C.2: Fixed Effects (Within estimator)

```{r ukol_c_2}
# Fixed effects model
# Kontrola individuÃ¡lnÃ­ch fixnÃ­ch efektÅ¯


```

**Interpretace:**
- Jak se liÅ¡Ã­ od pooled OLS?
- KterÃ© promÄ›nnÃ© "zmizely"?

## Ãškol C.3: Random Effects

```{r ukol_c_3}
# Random effects model


```

## Ãškol C.4: Hausman test

```{r ukol_c_4}
# Test FE vs RE (Hausman test)


```

**RozhodnutÃ­:** KterÃ½ model je vhodnÄ›jÅ¡Ã­ - FE nebo RE?

## Ãškol C.5: Time Fixed Effects

```{r ukol_c_5}
# PÅ™idÃ¡nÃ­ ÄasovÃ½ch fixnÃ­ch efektÅ¯


```

## Ãškol C.6: Two-way Fixed Effects

```{r ukol_c_6}
# IndividuÃ¡lnÃ­ i ÄasovÃ© fixnÃ­ efekty


```

---

# ğŸ“ˆ CviÄenÃ­ D: VykreslenÃ­ odhadÅ¯

Vizualizace vÃ½sledkÅ¯ regresnÃ­ analÃ½zy.

## Graf koeficientÅ¯

```{r ukol_d_1}
# VytvoÅ™te graf koeficientÅ¯ s konfidenÄnÃ­mi intervaly


```

## SrovnÃ¡nÃ­ modelÅ¯

```{r ukol_d_2}
# SrovnÃ¡nÃ­ vÃ­ce modelÅ¯ v jednom grafu


```

## Predikce s intervaly

```{r ukol_d_3}
# Graf predikovanÃ½ch hodnot s konfidenÄnÃ­mi intervaly


```

## MarginÃ¡lnÃ­ efekty

```{r ukol_d_4}
# Vizualizace marginÃ¡lnÃ­ch efektÅ¯


```

---

# ğŸ“‹ Tabulky vÃ½sledkÅ¯

## ZÃ¡kladnÃ­ tabulka

```{r tabulky_1}
# Tabulka pomocÃ­ stargazer


```

## SrovnÃ¡vacÃ­ tabulka

```{r tabulky_2}
# SrovnÃ¡nÃ­ vÃ­ce modelÅ¯


```

## ModernÃ­ tabulky

```{r tabulky_3}
# PouÅ¾itÃ­ modelsummary balÃ­ku


```

---

# ğŸ’¡ DÅ¯leÅ¾itÃ© poznÃ¡mky

## OLS pÅ™edpoklady

1. **Linearita** - vztah mezi X a Y je lineÃ¡rnÃ­
2. **NezÃ¡vislost** - pozorovÃ¡nÃ­ jsou nezÃ¡vislÃ¡
3. **Homoskedasticita** - konstantnÃ­ rozptyl chyb
4. **Normalita** - chyby majÃ­ normÃ¡lnÃ­ rozdÄ›lenÃ­
5. **Å½Ã¡dnÃ¡ multikolinearita** - X promÄ›nnÃ© nejsou perfektnÄ› korelovÃ¡ny

## DiagnostickÃ© testy

```r
# Heteroskedasticita
lmtest::bptest(model)          # Breusch-Pagan test

# Autokorelace
lmtest::dwtest(model)          # Durbin-Watson test

# Normalita reziduÃ­
shapiro.test(residuals(model)) # Shapiro-Wilk test

# Multikolinearita
car::vif(model)                # Variance Inflation Factor
```

## RobustnÃ­ standardnÃ­ chyby

```r
# HC0 - White
coeftest(model, vcov = vcovHC(model, type = "HC0"))

# HC1 - Äasto pouÅ¾Ã­vanÃ½
coeftest(model, vcov = vcovHC(model, type = "HC1"))

# HAC - heteroskedasticita a autokorelace
coeftest(model, vcov = vcovHAC(model))

# KlastrovanÃ©
coeftest(model, vcov = vcovCL(model, cluster = ~group))
```

---

# ğŸ”§ UÅ¾iteÄnÃ© funkce

## ZÃ¡kladnÃ­ regresnÃ­ funkce

```r
# Odhad modelu
lm(y ~ x1 + x2, data = data)

# Summary vÃ½sledkÅ¯
summary(model)

# Predikce
predict(model, newdata = new_data, interval = "confidence")

# ResiduÃ¡ly
residuals(model)
resid(model)

# Fitted values
fitted(model)
fitted.values(model)

# Koeficienty
coef(model)
coefficients(model)
```

## PanelovÃ© modely (plm)

```r
# NastavenÃ­ panelu
pdata <- pdata.frame(data, index = c("id", "time"))

# Fixed effects
plm(y ~ x, data = pdata, model = "within")

# Random effects
plm(y ~ x, data = pdata, model = "random")

# Pooled OLS
plm(y ~ x, data = pdata, model = "pooling")

# First differences
plm(y ~ x, data = pdata, model = "fd")
```

## broom funkce

```r
# Tabulka koeficientÅ¯
tidy(model)

# Model statistics
glance(model)

# Augmented data
augment(model)
```

---

# ğŸ“Š Interpretace koeficientÅ¯

## ZÃ¡kladnÃ­ interpretace

```r
# Level-level: y = Î²â‚€ + Î²â‚x
# Interpretace: ZmÄ›na x o 1 jednotku â†’ zmÄ›na y o Î²â‚ jednotek
```

## Semi-logaritmickÃ© modely

```r
# Log-level: log(y) = Î²â‚€ + Î²â‚x
# Interpretace: ZmÄ›na x o 1 jednotku â†’ zmÄ›na y o (100 Ã— Î²â‚)%

# Level-log: y = Î²â‚€ + Î²â‚log(x)
# Interpretace: ZmÄ›na x o 1% â†’ zmÄ›na y o (Î²â‚/100) jednotek
```

## Log-log modely (elasticity)

```r
# Log-log: log(y) = Î²â‚€ + Î²â‚log(x)
# Interpretace: Î²â‚ je elasticita - zmÄ›na x o 1% â†’ zmÄ›na y o Î²â‚%
```

## Dummy promÄ›nnÃ©

```r
# y = Î²â‚€ + Î²â‚D
# Interpretace: KdyÅ¾ D=1, y je o Î²â‚ vyÅ¡Å¡Ã­ neÅ¾ kdyÅ¾ D=0
```

---

# ğŸ¯ Checklist

- [ ] RozumÃ­m zÃ¡kladnÃ­m pÅ™edpokladÅ¯m OLS?
- [ ] VÃ­m, jak odhadnout a interpretovat lineÃ¡rnÃ­ model?
- [ ] DokÃ¡Å¾u provÃ©st diagnostiku modelu?
- [ ] UmÃ­m pracovat s robustnÃ­mi standardnÃ­mi chybami?
- [ ] ChÃ¡pu rozdÃ­l mezi fixed a random effects?
- [ ] VÃ­m, kdy pouÅ¾Ã­t panelovÃ© modely?
- [ ] DokÃ¡Å¾u vizualizovat vÃ½sledky regrese?
- [ ] UmÃ­m vytvoÅ™it profesionÃ¡lnÃ­ tabulky vÃ½sledkÅ¯?

---

# ğŸ”— UÅ¾iteÄnÃ© odkazy

- [Introduction to Econometrics with R](https://www.econometrics-with-r.org/)
- [plm package documentation](https://cran.r-project.org/web/packages/plm/vignettes/plmPackage.html)
- [broom package](https://broom.tidymodels.org/)
- [modelsummary package](https://modelsummary.com/)
- [Econometric Analysis (Greene)](http://pages.stern.nyu.edu/~wgreene/Text/econometricanalysis.htm)

---

# ğŸ“š DoporuÄenÃ¡ literatura

- **Wooldridge, J. M.**: Introductory Econometrics: A Modern Approach
- **Greene, W. H.**: Econometric Analysis
- **Angrist, J. D. & Pischke, J-S.**: Mostly Harmless Econometrics
- **Stock, J. H. & Watson, M. W.**: Introduction to Econometrics

---

<div style="text-align: center; margin-top: 50px; padding: 20px; background-color: #f0f0f0; border-radius: 10px;">
**VytvorenÃ© pre:** MPE_AVED, TÃ½Å¾deÅˆ 12, ECON MUNI  
**DÃ¡tum:** `r Sys.Date()`
</div>
