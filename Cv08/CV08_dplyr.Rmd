---
title: "CviÄenÃ­ 8: dplyr - ManipulÃ¡cia s dÃ¡tami"
subtitle: "MPE_AVED - AnalÃ½za a vizualizace ekonomickÃ½ch dat"
author: "Mgr. Dana KozÃ¡kovÃ¡"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: false
    theme: cosmo
    highlight: tango
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  comment = "#>"
)
```

# NaÄÃ­tÃ¡nÃ­ balÃ­kÅ¯

```{r packages}
library(tidyverse)
library(dplyr)
```
---

# CviÄenÃ­ na rozcviÄenÃ­
NaÄtÄ›te si data o sportovcÃ­ch, kteÅ™Ã­ se zÃºÄastnili OlympijskÃ½ch her v LondÃ½nÄ› (`VGAMdata::oly12`) a tabulku si pÅ™eklopte do `tibble`.

```{r ukol_rozehnuti_data}
oly12 <- VGAMdata::oly12 %>% as_tibble()
oly12
```
Nejprve data vyÄistÃ­me. VyÅ™adÃ­me vÅ¡echny sportovce, kteÅ™Ã­ nastupujÃ­ ve vÃ­ce sportech. (To poznÃ¡me tak, Å¾e sloupec `Sport` obsahuje znak ",".)
TakÃ© vyÅ™adÃ­me ty, u kterÃ½ch chybÃ­ Ãºdaj o vÃ½Å¡ce, vÃ¡ze, nebo pohlavÃ­.
```{r}
oly12 <- oly12 %>% 
  filter(!str_detect(Sport, ',')) %>%
  drop_na(Height, Weight, Sex)
oly12
```

NynÃ­ do tabulky doplÅˆte novÃ½ sloupec (`bmi`) s BMI (`bmi = Weight / (Height)^2`) a najdÄ›te muÅ¾e s nejniÅ¾Å¡Ã­m BMI.

```{r}
oly12 <- oly12 %>% 
  mutate(bmi = Weight / (Height)^2)

oly12 %>%
  filter(Sex == 'M') %>%
  arrange(bmi) %>% slice(1L)

oly12 %>%
  filter(Sex == 'M') %>%
  slice_min(bmi, n = 1) 

```

Ve kterÃ©m sportu jsou sportovci nevychrtlejÅ¡Ã­? Zkuste i rozliÅ¡enÃ­ podle pohlavÃ­.

```{r}
oly12 %>%
  group_by(Sport, Sex) %>%
  dplyr::summarise(
    meanBMI = mean(bmi, na.rm = TRUE)
  ) %>%
  arrange(meanBMI)
```

Kolik bych vÃ¡Å¾il, kdybych byl na pÅ¯mÄ›ru... DopoÄÃ­tejte svoji oÄekÃ¡vanou vÃ¡hu v kaÅ¾dÃ©m sportu pÅ™i svÃ© skuteÄnÃ© vÃ½Å¡ce a pohlavÃ­.

```{r}
oly12 %>%
  group_by(Sport, Sex) %>%
  dplyr::summarise(
    meanBMI = mean(bmi, na.rm = TRUE)
  ) %>%
  pivot_wider(names_from = Sex, values_from = meanBMI) %>%
  mutate(myProjectedWeight = F*(1.6^2)) %>%
  arrange(-myProjectedWeight)
```


---

#  CviÄenÃ­ 1: Privatizace a restituce v ÄŒR

V tomto pÅ™Ã­kladÄ› budete pracovat s daty o jednotlivÃ½ch domech (tabulka `domy`). Ty ve svÃ© struktuÅ™e, datovÃ½ch typech, kÃ³dech a jmÃ©nech promÄ›nnÃ½ch pÅ™esnÄ› odpovÃ­dajÃ­ datÅ¯m, kterÃ¡ poskytuje ÄŒSÃš. Tabulka obsahuje unikÃ¡tnÃ­ identifikÃ¡tor domu -- tzv. IDOB v promÄ›nnÃ© `LIDAMSIDOB`. Tento klÃ­Ä je pro ÃºÄely tohoto cviÄenÃ­ vygenerovÃ¡n nÃ¡hodnÄ›. 

ÄŒSÃš nemÃ¡ data o privatizaci, kterÃ¡ musÃ­ bÃ½t doplnÄ›na z jinÃ©ho zdroje. Ten pro nÃ¡s pÅ™edstavuje tabulka `privatizace`, kterÃ¡ obsahuje IDOB ve sloupci `IDOB` a rok provedenÃ­ privatizace ve sloupci `year`. 

VaÅ¡im Ãºkolem je v koneÄnÃ©m dÅ¯sledku rozhodnout o kaÅ¾dÃ©m jednotlivÃ©m domÄ›, zda byl restituovÃ¡n, privatizovÃ¡n nebo nespadÃ¡ ani do jednÃ© tÃ©to kategorie. PrivatizovanÃ© domy identifikujete tak, Å¾a majÃ­ zÃ¡znam v tabulce `privatizace`.

## NaÄtenÃ­ dat

```{r ukol_1_nacteni}
load("dplyr_exercise_01.RData")
domy %>%
  print(n = 5)
```
## Ãškol 1.1: SlouÄenÃ­ tabulek

PrvnÃ­m krokem je slouÄenÃ­ (join) obou tabulek

```{r}
domy %>%
  select(LIDAMSIDOB, everything()) %>%
  print(n = 5)

privatizace  %>%
  select(IDOB, everything()) %>%
  print(n = 5)

domy_priv <- domy %>% 
  mutate(LIDAMSIDOB = as.character(LIDAMSIDOB)) %>%
  left_join(privatizace,by = c('LIDAMSIDOB' ='IDOB'))  %>%
  select(LIDAMSIDOB, year, everything())
domy_priv
```

## Ãškol 1.2: Sloupec pro restituce, privatizaci

RestituovanÃ© domy jsou ty, kterÃ© byly postaveny pÅ™ed rokem 1945 (promÄ›nnÃ¡ `OBDVD` mÃ¡ u nich hodnotu 10 nebo 3), v roce 1991 je vlastnil stÃ¡t (promÄ›nnÃ¡ `kod91_vlast` mÃ¡ hodnotu 1) a v roce 2001 uÅ¾ je vlastnil restituent -- fyzickÃ¡ osoba (promÄ›nnÃ¡ `jvlast_r01` mÃ¡ hodnotu 1).

V druhÃ©m kroku vytvoÅ™Ã­me ve slouÄenÃ© tabulce promÄ›nnou `status`, kterÃ¡ bude nabÃ½vat hodnot `restituted`, `privatized` nebo `other`. Pozor! Nechceme Å¾Ã¡dnÃ¡ `NA`!

**DoporuÄenÃ­:** PodÃ­vejte se na funkci `case_when()`.

```{r}
domy_priv %>%
  select(LIDAMSIDOB, kod91_vlast, OBDVD, jvlast_r01, everything())

domy_priv %>%
  mutate(
    status = case_when(
      OBDVD %in% c('3', '10') & kod91_vlast == 1 & jvlast_r01 == 1 ~ 'restituted',
      !is.na(year) ~ 'privatized',
      TRUE ~ 'other'
    ) 
  ) %>%
  select(status, everything())

domy_priv %>%
  mutate(
    status = case_when(
      OBDVD %in% c('3', '10') & kod91_vlast == 1 & jvlast_r01 == 1 ~ 'restituted',
      !is.na(year) ~ 'privatized',
      TRUE ~ 'other'
    ) 
  ) %>%
  select(status, everything()) %>%
  count(status)
        
```
---

# CviÄenÃ­ 2: Census v otevÅ™enÃ½ch datech ÄŒSÃš

PrÃ¡ce s otevÅ™enÃ½mi daty z ÄŒeskÃ©ho statistickÃ©ho ÃºÅ™adu.

```{r ukol_2_nacteni}
sldb <- read_csv('SLDB_OBYVATELSTVO_2011.CSV', locale = locale(encoding = 'latin2'))
sldb

```

## Ãškol 2.1: VÃ½bÄ›r relevantnÃ­ch Å™Ã¡dkÅ¯ - tidy
PrvnÃ­ pohled ukazuje, Å¾e data od ÄŒSÃš nejsou *tidy*. PrvnÃ­m krokem tedy bude data do tohoto formÃ¡tu pÅ™evÃ©st. KonkrÃ©tnÄ› v tabulce ponechat pouze pozorovÃ¡nÃ­ za obce (promÄ›nnÃ¡ `typuz_naz`).
```{r ukol_2_1}
sldb %>% 
  count(typuz_naz)

sldb <- sldb %>%
  filter(typuz_naz == 'obec')
sldb
```

## Ãškol 2.2: NezamÄ›stnanost
NynÃ­ pro kaÅ¾dou obec vypoÄÃ­tejte mÃ­ru nezamÄ›stnanosti jako `vse6181/vse6111` (nezamÄ›stnanÃ­/ekonomicky aktivnÃ­).
```{r ukol_2_2}
sldb <- sldb %>%
  mutate(
    u_rate = vse6181/vse6111
  ) %>% 
  select(u_rate, everything())

sldb %>% print(n = 5)
```

## Ãškol 2.3 Nezamestnanost v kraji
NynÃ­ pro kaÅ¾dÃ½ kraj spoÄÃ­tejte minimÃ¡lnÃ­, prÅ¯mÄ›rnou a maximÃ¡lnÃ­ mÃ­ru nezamÄ›stanosti na Ãºrovni obcÃ­. ZvlÃ¡Å¡Å¥ vypoÄÃ­tejte tyto hodnoty pro malÃ© (do 1000 obyvatel) a ostatnÃ­ obce.

PoÄet obyvatel najdete ve sloupci `vse1111`.

Pro tento Ãºkol budete potÅ™ebovat tabulku pÅ™iÅ™azujÃ­cÃ­ obce do krajÅ¯. Tu najdete v `tabulka_obci.RData`.

```{r ukol_2_3}

load("tabulka_obci.RData")
tabulka_obci

sldb %>% 
  mutate(
    KOD_OBEC = as.character(uzkod)
    ) %>%
  left_join(tabulka_obci,by = 'KOD_OBEC') %>%
  mutate(
    pop_category = case_when(
      vse1111 <= 1000 ~ 'male',
      TRUE ~ 'velke'
    )
  ) %>%
  # select(KOD_OBEC, KOD_KRAJ, pop_category, everything()) %>%
  group_by(KOD_KRAJ, pop_category) %>%
  summarise(
    min = min(u_rate, na.rm = TRUE),
    mean = mean(u_rate, na.rm = TRUE),
    max = max(u_rate, na.rm = TRUE)
  )
```

---

# CviÄenÃ­ 3: WIID data

AnalÃ½za dat o pÅ™Ã­jmovÃ© nerovnosti z World Income Inequality Database.

## NaÄtenÃ­ dat

```{r ukol_3_nacteni}
wiid <- read_tsv('WIID_ver3_sept15_0.tsv')
wiid %>% print()

```

## Ãškol 3.1: ExplorativnÃ­ analÃ½za
WIID je sbÃ­rkÅ¯ ÃºdajÅ¯ o nerovnosti sesbÃ­ranÃ½ch z mnoha rÅ¯znÃ½ch zdrojÅ¯. My se zamÄ›Å™Ã­me na Giniho koeficent (`Gini`). KaÅ¾dÃ¡ pozorovÃ¡nÃ­ je hodnoceno podle kvality (`Quality`) od `High` (nejlepÅ¡Ã­) po `Not known` (nejhorÅ¡Ã­). Abychom zÃ­skali lepÅ¡Ã­ pÅ™ehled o organizaci datasetu omezÃ­me si tabulku pouze na sloupce `Country`, `Year`, `Gini` a `Quality`:

```{r ukol_3_1}
wiid <- wiid %>% 
    select(Country, Year, Gini, Quality)
wiid %>% print()


```

## Ãškol 3.2: Oprava
Na pÅ™Ã­kladu vidÃ­te, Å¾e pro nÄ›kterÃ© stÃ¡ty je pro jeden rok dostupnÃ½ch vÃ­ce pozorovÃ¡nÃ­. V dalÅ¡Ã­m kroku budeme chtÃ­t dataset upravit tak, aby se v takovÃ©m pÅ™Ã­padÄ› pouÅ¾ilo pozorovÃ¡nÃ­ s vyÅ¡Å¡Ã­m hodnocenÃ­m kvality.


```{r ukol_3_2}
wiid %>% 
  drop_na(Gini) %>%
  mutate(
    Quality = factor(Quality, levels = c('High','Average','Low','Not known'))
  ) %>%
  group_by(Country, Year) %>%
  arrange(Quality, .by_group = TRUE) %>%
  slice(1L) %>%
  ungroup()

```

# CviÄenÃ­ 4: SpojovÃ¡nÃ­ tabulek

V tomto cviÄenÃ­ pouÅ¾ijeme tabulky z *dplyr*: `band_instruments` a `band_members`. Tabulku `band_members` si nejprve upravÃ­me:

```{r ukol_4_priprava}
band_members2 <- band_members %>% 
  filter(name != 'Mick')

band_members2
```

NynÃ­ spojte tabulky `band_instruments` a `band_members2`. VÃ½slednÃ¡ tabulka bude mÃ­t rozmÄ›ry 3 $\times$ 3. PouÅ¾itÃ­ funkcÃ­ `*_join()` je v tomto cviÄenÃ­ zakÃ¡zÃ¡no. NavrhnÄ›te Å™eÅ¡enÃ­ s pomocÃ­ funkcÃ­ z *tidyverse*.

```{r ukol_4_1}
band_instruments

band_members3 <- band_members2 %>%
  complete( name = band_instruments$name) %>%
  arrange(name)

band_instruments %>%
  arrange(name) %>%
  bind_cols(select(band_members3, - name))
  
```


---

# CviÄenÃ­ 5: NahrazenÃ­ chybÄ›jÃ­cÃ­ch hodnot

PrÃ¡ce s chybÄ›jÃ­cÃ­mi hodnotami v datech.

```{r ukol_5_nacteni}
load('dplyr_Gasoline.RData')
Gasoline

```

## Ãškol 5.1: NA - nahrazeni prumerem pro zemi
Nahradit NA.Pro nahrazenÃ­ pouÅ¾ijte prÅ¯mÄ›rnou hodnotu pro zemi.

```{r ukol_5_reseni_1}

Gasoline %>%
  pivot_longer(-c(country, year), names_to = 'variable') %>%
  arrange(country, year)

Gasoline %>%
  pivot_longer(-c(country, year), names_to = 'variable') %>%
  arrange(country, year) %>%
  group_by(country, variable) %>%
  mutate(
    value = ifelse(is.na(value), mean(value, na.rm = TRUE), value)
  ) %>%
  ungroup()

Gasoline %>%
  pivot_longer(-c(country, year), names_to = 'variable') %>%
  arrange(country, year) %>%
  group_by(country, variable) %>%
  mutate(
    value = ifelse(is.na(value), mean(value, na.rm = TRUE), value)
  ) %>%
  ungroup() %>%
  pivot_wider(names_from = variable)
```
ine riesenie
```{r}
Gasoline %>%
  group_by(country) %>%
  mutate(
    across(where(is.double), 
           \(x) replace_na(x, mean(x, na.rm = TRUE)))
  ) %>%
  ungroup()
```

## Ukol 5.2
Pro nahrazenÃ­ pouÅ¾ijte "kumulativnÃ­ prÅ¯mÄ›r" -- tj. prÅ¯mÄ›r vÅ¡ech pÅ™edchozÃ­ch hodnot.

Hint: **dplyr** mÃ¡ (omezenÃ©) mnoÅ¾stvÃ­ tzv. window functions -- napÅ™. `cummean()`

MÄ›lo by staÄit nahradit `mean()`, ale `cummean()` si nedokÃ¡Å¾e poradiÅ¥ s NA:
```{r ukol_5_reseni_2}
Gasoline %>%
  pivot_longer(-c(country, year), names_to = 'variable') %>%
  arrange(country, year) %>%
  group_by(country, variable) %>%
  mutate(
    value = ifelse(is.na(value), cummean(value), value)
  ) %>%
  ungroup() %>%
  pivot_wider(names_from = variable)
```

```{r ukol_5_reseni_3}

Gasoline %>%
  pivot_longer(-c(country, year), names_to = 'variable') %>%
  arrange(country, year) %>%
  drop_na() %>% # tu vyhodime NA
  group_by(country, variable) %>%
  mutate(
    mean_value = ifelse(is.na(value), cummean(value), value)
  ) %>%
  ungroup() %>%
  complete(country,year = 1960:1978, variable) %>%  # spat vsetky riadky
  group_by(country, variable) %>% 
  mutate(
    value = ifelse(is.na(value), lag(mean_value), value) # ina window funkcia lag()
  ) %>% 
  # a teraz staÄÃ­ tabulku vrÃ¡tit do povodnÃ©ho tvaru...
  select(-mean_value) %>% 
  ungroup() %>% 
  pivot_wider(names_from = variable)

```
## Ukol 5.3 KlouzavÃ½ prÅ¯mÄ›r
Pro nahrazenÃ­ pouÅ¾ijte klouzavÃ½ prÅ¯mÄ›r.
```{r}
library(slider)

Gasoline %>% 
    group_by(country) %>%
    arrange(year) %>%
    mutate(
        lcarpcap_ = slide_dbl(lcarpcap, mean, .before = 5)
    )

```
---

# ğŸ“ PÅ™ehled funkcÃ­ dplyr

## ZÃ¡kladnÃ­ transformace

```r
# VÃ½bÄ›r sloupcÅ¯
select(data, col1, col2)
select(data, starts_with("prefix"))
select(data, -col_to_remove)

# FiltrovÃ¡nÃ­ Å™Ã¡dkÅ¯
filter(data, condition)
filter(data, col1 > 10, col2 == "value")

# Å˜azenÃ­
arrange(data, col1)
arrange(data, desc(col2))

# VytvÃ¡Å™enÃ­ novÃ½ch promÄ›nnÃ½ch
mutate(data, new_col = expression)
mutate(data, new_col1 = expr1, new_col2 = expr2)
```

## Agregace a seskupenÃ­

```r
# SeskupenÃ­
group_by(data, col1, col2)

# Agregace
summarise(data, mean_val = mean(col), sum_val = sum(col))

# PoÄÃ­tÃ¡nÃ­
count(data, col1, col2)
n()
n_distinct()
```

## SpojovÃ¡nÃ­ tabulek

```r
# Inner join - pouze Å™Ã¡dky se shodou v obou tabulkÃ¡ch
inner_join(x, y, by = "key")

# Left join - vÅ¡echny Å™Ã¡dky z x
left_join(x, y, by = "key")

# Right join - vÅ¡echny Å™Ã¡dky z y
right_join(x, y, by = "key")

# Full join - vÅ¡echny Å™Ã¡dky z obou tabulek
full_join(x, y, by = "key")

# Semi join - Å™Ã¡dky z x se shodou v y (bez sloupcÅ¯ z y)
semi_join(x, y, by = "key")

# Anti join - Å™Ã¡dky z x BEZ shody v y
anti_join(x, y, by = "key")
```

---

# ğŸ’¡ DÅ¯leÅ¾itÃ© poznÃ¡mky

## Pipe operÃ¡tor %>%

Pipe operÃ¡tor umoÅ¾Åˆuje Å™etÄ›zenÃ­ operacÃ­:

```r
# MÃ­sto:
result <- function3(function2(function1(data)))

# PouÅ¾ijte:
result <- data %>%
  function1() %>%
  function2() %>%
  function3()
```

## ÄŒastÃ© problÃ©my a Å™eÅ¡enÃ­

### ProblÃ©m 1: JmÃ©na sloupcÅ¯ s mezerami

```r
# âŒ CHYBA
select(data, column name)

# âœ… Å˜EÅ ENÃ
select(data, `column name`)
```

### ProblÃ©m 2: ZapomenutÃ­ ungroup()

```r
# âŒ NebezpeÄnÃ© - data zÅ¯stÃ¡vajÃ­ seskupenÃ¡
data %>%
  group_by(id) %>%
  mutate(mean_val = mean(value))

# âœ… BezpeÄnÃ©
data %>%
  group_by(id) %>%
  mutate(mean_val = mean(value)) %>%
  ungroup()
```

### ProblÃ©m 3: PouÅ¾itÃ­ summarise() vs mutate()

```r
# summarise() - redukuje poÄet Å™Ã¡dkÅ¯
data %>%
  group_by(group) %>%
  summarise(mean_val = mean(value))  # Jeden Å™Ã¡dek na skupinu

# mutate() - zachovÃ¡vÃ¡ poÄet Å™Ã¡dkÅ¯
data %>%
  group_by(group) %>%
  mutate(mean_val = mean(value))  # StejnÃ½ poÄet Å™Ã¡dkÅ¯ jako pÅ¯vodnÃ­ data
```

---

# ğŸ¯ Checklist

- [ ] RozumÃ­m rozdÃ­lu mezi `select()` a `filter()`?
- [ ] VÃ­m, kdy pouÅ¾Ã­t `mutate()` a `summarise()`?
- [ ] DokÃ¡Å¾u efektivnÄ› pouÅ¾Ã­vat pipe operÃ¡tor `%>%`?
- [ ] ChÃ¡pu rozdÃ­ly mezi rÅ¯znÃ½mi typy joinÅ¯?
- [ ] VÃ­m, jak pracovat s chybÄ›jÃ­cÃ­mi hodnotami?
- [ ] UmÃ­m kombinovat vÃ­ce dplyr operacÃ­ dohromady?

---

# ğŸ”— UÅ¾iteÄnÃ© odkazy

- [dplyr cheatsheet](https://github.com/rstudio/cheatsheets/blob/main/data-transformation.pdf)
- [R for Data Science - Data transformation](https://r4ds.had.co.nz/transform.html)
- [dplyr documentation](https://dplyr.tidyverse.org/)


